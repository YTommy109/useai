# 7. クライアント側の状態管理に _hyperscript を採用

日付: 2025-12-11

## ステータス

承認済み (Accepted)

## コンテキスト

実行ボタンの有効/無効を制御するために、チェックボックスの変更のたびに `/update_main_interface` エンドポイントへPOSTリクエストを送信し、サーバー側で `is_executable` を計算してform全体を更新する実装になっていました。

この実装には以下の問題がありました：

1. **過剰なサーバーリクエスト**: 単純なUI状態の変更のために、毎回サーバーへリクエストを送信していた
2. **パフォーマンス**: ネットワーク往復とサーバー処理による遅延が発生していた
3. **設計の複雑化**: サーバー側でUI状態を管理する必要があり、責務の分離が不適切だった

クライアント側で状態を管理する方が適切であると判断し、JavaScriptの導入を検討しました。

## 決定

クライアント側の状態管理に **_hyperscript** を採用します。

選択肢として以下を検討しました：

1. **Vanilla JS**: 依存なし、シンプルだがコード量が増える
2. **_hyperscript**: htmxの作者が推奨、宣言的でHTML属性に直接記述可能
3. **Alpine.js**: 人気だが、この用途には過剰
4. **Petite Vue**: 軽量だが、この用途には過剰

_hyperscriptを選択した理由：

- **htmxとの統合**: htmxの作者が推奨しており、設計思想が一致している
- **宣言的な記述**: HTML属性に直接記述でき、コードとUIが近い位置にある
- **学習体験**: htmx作者の思想を取り入れた設計を体験できる
- **イベント駆動**: `on change`、`on load`、`on htmx:afterSwap` など、htmxイベントと自然に統合できる

実装内容：

- formの `on change` イベントでチェックボックスの変更を監視
- 国または法規が1つ以上選択されている場合に実行ボタンを有効化
- 初期状態は常に `disabled`、ユーザー操作時に状態が更新される

## 結果

### メリット

- **サーバーリクエストの削減**: UI状態の変更をクライアント側で処理するため、不要なサーバーリクエストがなくなった
- **パフォーマンス向上**: ネットワーク往復がなくなり、即座にUIが更新される
- **責務の分離**: UI状態管理がクライアント側に移り、サーバー側のコードが簡潔になった
- **宣言的な記述**: HTML属性に直接記述できるため、コードとUIの関係が明確
- **htmxとの統合**: htmxイベント（`htmx:afterSwap`など）と自然に統合できる

### デメリット

- **学習コスト**: _hyperscriptは独自の構文を持つため、学習が必要
- **コミュニティ**: 他のライブラリと比べてコミュニティが小さい
- **デバッグ**: ブラウザの開発者ツールでのデバッグがやや難しい場合がある

### 削除したコード

- `/update_main_interface` エンドポイント（不要になった）
- サーバー側の `is_executable` パラメータ（クライアント側で管理）
