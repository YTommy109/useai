# 0002 – Adopt Atlas for SQLite Migration

## ステータス

置き換え (Superseded) - [ADR-0004](0004-deprecate-atlas-adopt-alembic.md) によって置き換えられました。
- 日付: 2025-11-21

## 背景

本プロジェクトでは、マスタデータおよびトランザクションデータの主要なデータベースとして SQLite を使用しています。データベーススキーマの変更（マイグレーション）を管理するために、堅牢でバージョン管理が可能、かつ信頼性の高い方法が必要です。

SQLite はファイルベースのデータベースであり、手動やアドホックなスクリプトでスキーマ変更を管理すると、不整合が生じたり、共同作業が困難になったりする可能性があります。以下の機能を備えたツールが必要です：

- 宣言的なスキーマ定義（Infrastructure as Code）
- スキーマ変更に基づくマイグレーションの自動生成
- SQLite との互換性
- 開発ワークフローへの容易な統合

## 決定

SQLite のデータベースマイグレーションツールとして **Atlas** (<https://atlasgo.io>) を採用します。

Atlas は、データベーススキーマをコードとして扱う最新のデータベーススキーマ管理ツールです。SQLite をサポートしており、以下の機能を提供します：

- **宣言的ワークフロー**: HCL (HashiCorp Configuration Language) または SQL で希望するスキーマ状態を定義でき、Atlas がその状態への移行を処理します。
- **マイグレーション計画の自動化**: Atlas はデータベースと希望する状態を検査し、マイグレーションファイルを自動的に生成できます。
- **バージョン管理されたマイグレーション**: Git ベースのワークフローと相性の良い、バージョン管理されたマイグレーションファイルをサポートしています。
- **SQLite サポート**: 検査や変更の適用を含め、SQLite を完全にサポートしています。

## 影響

- **Schema as Code**: データベーススキーマがバージョン管理されたファイル (`schema.hcl`) で定義されるため、可視性と監査性が向上します。
- **信頼性の高いマイグレーション**: 自動化されたマイグレーション計画により、マイグレーションスクリプト作成時の人為的ミスのリスクが軽減されます。
- **標準化されたワークフロー**: ローカル開発や将来的な環境全体で、DB 変更を管理する一貫した方法が提供されます。
- **最新のツール**: Atlas は活発にメンテナンスされており、データベースタスクを管理するための豊富な CLI を提供しています。
- **新しいツールの学習コスト**: 開発者は Atlas CLI コマンドと HCL 構文（直感的ではありますが）を学ぶ必要があります。
- **依存関係**: Atlas バイナリ/ツールチェーンへの依存が追加されます。

## 実装

- プロジェクトルートで Atlas を初期化します。
- SQLite スキーマを定義するための `schema.hcl` ファイルを作成します。
- `atlas schema apply` またはバージョン管理されたマイグレーションワークフローを使用して、SQLite データベースファイルを管理します。
