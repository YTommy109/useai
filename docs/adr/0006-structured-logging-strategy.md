# 6. 構造化ロギングとローテーション方針の採用

日付: 2025-12-05

## ステータス

決定

## コンテキスト

現在開発中のアプリケーションはローカル環境で動作する Web アプリケーションである。
開発中のデバッグや、運用時のエラー調査（"server error" 等の原因究明）のために、適切なロギング機構が必要とされている。

これまではコンソールへの標準出力のみで運用されていたが、以下の課題がある：
1. 過去のログが残らないため、事後調査が困難。
2. 非構造化テキストログでは、プログラムによる解析や検索がしにくい。
3. ログファイルが無制限に肥大化するリスクを避ける必要がある。
4. 個人情報（アカウント情報など）の漏洩リスクを考慮する必要がある。

## 決定

以下のロギング方針を採用する。

### 1. ライブラリ選定
Python 標準の `logging` モジュールを使用する。
*   **理由**: 外部依存を増やさず、十分な機能（ハンドラ、フォーマッタ、フィルタ）を備えているため。

### 2. ログフォーマット
**JSON Lines (JSONL)** 形式を採用する。
*   **内容**: タイムスタンプ、ログレベル、ロガー名、メッセージ、発生箇所（ファイル名、行番号）、例外情報（スタックトレース）などを構造化して記録する。
*   **理由**: `jq` コマンドやログ解析ツールでの処理が容易であり、将来的な拡張性も高いため。

### 3. 出力先とファイル管理
*   **ディレクトリ**: プロジェクトルート直下の `.log/` ディレクトリ。
    *   `.gitignore` に追加し、Git 管理対象外とする。
    *   アプリケーション起動時にディレクトリが存在しなければ自動作成する。
*   **ファイル名**: `app.log`（または `useai.log`）。

### 4. ローテーション方針
`logging.handlers.TimedRotatingFileHandler` を使用する。
*   **タイミング**: 毎日深夜 0時 (midnight)。
*   **保持期間**: 28日間（4週間）。
*   **理由**: ディスク容量の圧迫を防ぎつつ、月次レベルでの振り返りが可能な期間を確保するため。

### 5. ログレベルと対象
*   **設定**: 環境変数（`.env`）の `LOG_LEVEL` で制御可能にする（デフォルト: INFO）。
*   **対象**: アプリケーション自身のログに加え、`uvicorn`、`sqlalchemy` などの主要ライブラリのログも同ファイルに統合して出力する。

### 6. プライバシーとセキュリティ
*   ユーザーのアカウント情報や機密情報はログに出力しない。
*   ローカルアプリであるため、過度なマスキングは行わないが、意図的な個人情報の出力は避ける。

## 結果

### メリット
*   エラー発生時の状況（いつ、どこで、何が起きたか）を正確に追跡できるようになる。
*   JSON形式であるため、ログのフィルタリングや集計が容易になる。
*   ログファイルの肥大化によるディスク圧迫を防げる。
*   標準ライブラリのみを使用するため、プロジェクトの依存関係をシンプルに保てる。

### デメリット
*   プレーンテキストに比べて、人間が直接読む際の可読性は若干下がる（ただし `jq` 等を使えば問題ない）。
*   JSON変換のオーバーヘッドがわずかに発生する（ローカルアプリの規模では無視できるレベル）。
